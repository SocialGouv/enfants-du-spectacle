app:
  ~needs: [build-app, db]
  envFrom:
    - secretRef:
        name: pg-user
    - secretRef:
        name: app-sealed-secret
    - configMapRef:
        name: app-configmap
  volumes:
    - name: docs
      emptyDir: {}
  volumeMounts:
    - mountPath: /mnt/docs
      name: docs

form:
  ~needs: [build-form, db-form]
  envFrom:
    - secretRef:
        name: pg-user-form
    - secretRef:
        name: app-sealed-secret
    - configMapRef:
        name: app-configmap
  volumes:
    - name: docs-form
      emptyDir: {}
  volumeMounts:
    - mountPath: /mnt/docs
      name: docs-form

jobs:
  runs:
    build-app:
      with:
        buildArgs:
          NEXT_PUBLIC_SENTRY_ENVIRONMENT: review
          START_SCRIPT: start-review
    build-form:
      with:
        buildArgs:
          NEXT_PUBLIC_SENTRY_ENVIRONMENT: review
          START_SCRIPT: start-review
    db:
      use: create-db
    db-form:
      use: create-db
      with:
        database: "form_{{.Values.global.branchSlug32}}"
        pgSecretName: pg-user-form
        pgUser: form_{{ .Values.global.branchSlug32 }}
