app:
  addVolumes:
    - docs
  envFrom:
    - secretRef:
        name: pg-user
    - secretRef:
        name: app-sealed-secret
    - configMapRef:
        name: app-configmap

form:
  addVolumes:
    - docs-form
  envFrom:
    - secretRef:
        name: pg-user-form # todo: remove after CNPG migration
    - secretRef:
        name: app-sealed-secret
    - configMapRef:
        name: app-configmap

pg-metabase:
  ~chart: pg

metabase:
  enabled: true
  ~needs: [pg-metabase]
  ingress:
    enabled: false
  envFrom:
    - configMapRef:
        name: metabase-configmap
    - secretRef:
        name: metabase-db-user

oauth2-proxy:
  host: "metabase-eds.fabrique.social.gouv.fr"
  enabled: true
  upstream: http://metabase
  envFrom:
    - configMapRef:
        name: oauth2-proxy-configmap
    - secretRef:
        name: oauth2-proxy-sealed-secret
  # additionalArgs:
  #   - --skip-auth-route
  #   - ^/public/.*,^/app/dist/.*,^/api/public/.*,^/api/session/.*,^/app/assets/.*

jobs:
  runs:
    build-app:
      with:
        buildArgs:
          NEXT_PUBLIC_SENTRY_DSN: https://11777d054b3c41c782ebced992346b39@sentry.fabrique.social.gouv.fr/59
          NEXT_PUBLIC_SENTRY_ENVIRONMENT: production
          START_SCRIPT: start-prod
          NEXT_PUBLIC_MATOMO_URL: https://matomo.fabrique.social.gouv.fr/
          NEXT_PUBLIC_MATOMO_SITE_AGENT_ID: 85
          NEXT_PUBLIC_API_URL_SDP: https://formulaire-enfants-du-spectacle.fabrique.social.gouv.fr/api/sync

    build-form:
      with:
        buildArgs:
          NEXT_PUBLIC_SENTRY_DSN: https://11777d054b3c41c782ebced992346b39@sentry.fabrique.social.gouv.fr/59
          NEXT_PUBLIC_SENTRY_ENVIRONMENT: production
          START_SCRIPT: start
          NEXT_PUBLIC_FORMULAIRE_HJID: 3347496
          NEXT_PUBLIC_FORMULAIRE_HJS: 6
          NEXT_PUBLIC_MATOMO_URL: https://matomo.fabrique.social.gouv.fr/
          NEXT_PUBLIC_MATOMO_SITE_FORMULAIRE_ID: 84
